import pandas as pd
from strategies.base_strategy import BaseStrategy
from common import mytt


class SampleAutoRebalanceStrategy(BaseStrategy):
    """
    å°ç™½ä¸“å±ï¼šæç®€å…¨è‡ªåŠ¨è½®åŠ¨ç­–ç•¥æ¨¡æ¿

    æ ¸å¿ƒé€»è¾‘ï¼šæ¯å¤©çœ‹ä¸€çœ¼æ‰€æœ‰æ ‡çš„çš„åŠ¨é‡ï¼ˆæ¶¨å¹…ï¼‰ï¼ŒæŒ‘å‡ºæ¶¨å¾—æœ€å¥½çš„å…¨ä»“ä¹°å…¥ã€‚
    äº®ç‚¹ï¼šä½ åªéœ€è¦è´Ÿè´£â€œé€‰è‚¡â€ï¼Œç®—é’±ã€é¿å¼€ç†è´¢åº•ä»“ã€ä¸‹å•ä¹°å–ï¼Œå…¨éƒ¨ç”±æ¡†æ¶è‡ªåŠ¨æå®šã€‚
    """

    # ç­–ç•¥çš„åˆå§‹è®¾ç½®
    params = {
        'selectTopK': 1,  # æ¯æ¬¡åªä¹°æ’åç¬¬ 1 çš„æ ‡çš„
        'roc_period': 20,  # è§‚å¯Ÿå®ƒè¿‡å» 20 å¤©çš„åŠ¨é‡ï¼ˆæ¶¨å¹…ï¼‰

        # ğŸ›¡ï¸ æ ¸å¿ƒæŠ¤ç›¾ï¼šå‘Šè¯‰ç³»ç»Ÿï¼Œè¿™é‡Œé¢çš„æ ‡çš„æ˜¯â€œç†è´¢åº•ä»“â€æˆ–â€œä¿¡ä»°è‚¡â€
        # ç³»ç»Ÿåœ¨ç®—é’±å’Œå–å‡ºæ—¶ï¼Œä¼šæŠŠå®ƒä»¬å½“åšç©ºæ°”ï¼Œç»å¯¹ä¸ä¼šåŠ¨å®ƒä»¬ä¸€åˆ†ä¸€æ¯«ï¼
        'ignored_symbols': ['SHSE.511880'],
    }

    def init(self):
        """
        å‡†å¤‡é˜¶æ®µï¼šæ¸¸æˆå¼€å§‹å‰ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ä¸€æ¬¡è¿™é‡Œã€‚
        """
        self.log("ç­–ç•¥åˆå§‹åŒ–ï¼šæ­£åœ¨æå‰è®¡ç®—æŒ‡æ ‡ï¼Œè®©å›æµ‹é£èµ·æ¥...")
        self.roc_signals = {}

        # ğŸ’¡ ä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡Œæå‰ç®—ï¼Ÿ
        # ä¸ºäº†é˜²æ­¢â€œçœ‹åˆ°æœªæ¥â€çš„ä½œå¼Šè¡Œä¸ºï¼Œä¹Ÿä¸ºäº†è®©å›æµ‹é€Ÿåº¦æå‡ç™¾å€ã€‚
        # æˆ‘ä»¬åœ¨è¿™é‡Œä¸€å£æ°”ç”¨ MyTT ç®—å‡ºæ‰€æœ‰å†å²æ•°æ®çš„ ROCï¼ˆåŠ¨é‡ï¼‰æ¶¨å¹…ã€‚
        for data in self.broker.datas:
            df = data.p.dataname
            if isinstance(df, pd.DataFrame):
                # ç”¨ MyTT ä¸€è¡Œä»£ç ç®—å‡º 20 æ—¥æ¶¨å¹…ï¼Œå¹¶æŒ‰æ—¥æœŸå­˜å¥½
                roc_array, _ = mytt.ROC(df['close'].values, self.p.roc_period)
                self.roc_signals[data._name] = pd.Series(roc_array, index=df.index)

    def next(self):
        """
        æ‰§è¡Œé˜¶æ®µï¼šå›æµ‹æˆ–å®ç›˜ä¸­ï¼Œæ¯ä¸€å¤©ï¼ˆæˆ–æ¯æ ¹ K çº¿ï¼‰éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡è¿™é‡Œã€‚
        """
        # è·å–â€œä»Šå¤©â€çš„æ—¥æœŸ
        current_dt = self.broker.datetime.datetime(0).replace(tzinfo=None)

        # ==========================================
        # ç¬¬ä¸€æ­¥ï¼šæ‰“åˆ†é€‰ç§€ï¼ˆåªçœ‹å¯äº¤æ˜“çš„æ± å­ï¼‰
        # ==========================================
        valid_candidates = []

        # ğŸª„ é­”æ³•æ‰€åœ¨ï¼šself.tradable_datas å·²ç»è‡ªåŠ¨å¸®ä½ æŠŠ SHSE.511880 å‰”é™¤äº†ï¼
        # ä½ é¢å¯¹çš„æ˜¯ä¸€ä¸ªæå…¶å¹²å‡€çš„â€œå¯æ“ä½œèµ„äº§æ± â€ã€‚
        for data in self.tradable_datas:
            try:
                # æ‹¿åˆ°è¿™åªæ ‡çš„åœ¨â€œä»Šå¤©â€çš„åŠ¨é‡å¾—åˆ†
                score = self.roc_signals[data._name].asof(current_dt)

                # åªè¦å¾—åˆ† > 0ï¼ˆä»£è¡¨å¤„äºä¸Šæ¶¨è¶‹åŠ¿ï¼‰ï¼Œå°±æœ‰èµ„æ ¼è¿›å…¥å€™é€‰åå•
                if pd.notna(score) and score > 0:
                    valid_candidates.append((data, score))
            except:
                pass  # å¦‚æœä¸Šå¸‚æ—¶é—´å¤ªçŸ­æ•°æ®ä¸è¶³ï¼Œç›´æ¥è·³è¿‡

        # ==========================================
        # ç¬¬äºŒæ­¥ï¼šæ’å‡ºåæ¬¡ï¼Œé€‰å‡ºå¤§å“¥
        # ==========================================
        # æŒ‰ç…§å¾—åˆ†ä»é«˜åˆ°ä½æ’åº
        valid_candidates.sort(key=lambda x: x[1], reverse=True)

        # æŒ‘å‡ºå‰ selectTopK åï¼ˆæŒ‰ç…§é…ç½®ï¼Œè¿™é‡Œä¼šæŒ‘å‡ºç¬¬ 1 åï¼‰
        targets = [item[0] for item in valid_candidates[:self.p.selectTopK]]

        # ==========================================
        # ç¬¬ä¸‰æ­¥ï¼šä¸€é”®æ‰§è¡Œï¼Œè®©æ¡†æ¶å»å¹²è„æ´»ç´¯æ´»
        # ==========================================
        # å°±åƒå°†å†›ä¸‹ä»¤ä¸€æ ·ï¼Œä½ åªéœ€è¦æŒ‡æ˜è¿›æ”»ç›®æ ‡ (targets)ã€‚
        # å¦‚æœå¤§ç›˜æš´è·Œæ²¡æœ‰æ ‡çš„æ»¡è¶³æ¡ä»¶ï¼Œtargets å°±æ˜¯ç©ºçš„ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¸®ä½ æ¸…ä»“é˜²å®ˆã€‚
        # åº•å±‚æ¡†æ¶ä¼šè‡ªåŠ¨ç®—å¯ç”¨èµ„é‡‘ã€æ‰£é™¤æ‰‹ç»­è´¹ã€æ¢ç®—è‚¡æ•°å¹¶å‘å•ã€‚
        self.execute_rebalance(
            target_symbols=targets,
            top_k=self.p.selectTopK,
            rebalance_threshold=0.05  # è®¾ç½® 5% çš„ç¼“å†²å¸¦ï¼Œé˜²æ­¢æ¯å¤©å¾®å°æ³¢åŠ¨å¯¼è‡´é¢‘ç¹ä¹°å–ç™½äº¤æ‰‹ç»­è´¹
        )